<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OptiFind - Find the best choice for you</title>
    
    <!-- External Resources -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" sizes="32x32" href="https://via.placeholder.com/32x32/6C8EF5/ffffff?text=O">
    <link rel="icon" type="image/png" sizes="16x16" href="https://via.placeholder.com/16x16/6C8EF5/ffffff?text=O">
    <link rel="apple-touch-icon" sizes="180x180" href="https://via.placeholder.com/180x180/6C8EF5/ffffff?text=OF">
    <link rel="manifest" href="manifest.json">


    <!-- ========== SOCIAL PREVIEW META TAGS (P0) ========== -->
    <meta property="og:title" content="OptiFind - Find the best choice for you">
    <meta property="og:description" content="Answer 3 quick questions and get personalized recommendations for books, courses, apps & skills.">
    <meta property="og:image" content="https://images.unsplash.com/photo-1559757148-5c350d0d3c56?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&h=630&q=80">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://optifind.app">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="OptiFind - Find the best choice for you">
    <meta name="theme-color" content="#6C8EF5">
    <link rel="canonical" href="https://optifind.app">
    <meta name="twitter:description" content="Answer 3 quick questions and get personalized recommendations.">
    <meta name="twitter:image" content="https://images.unsplash.com/photo-1559757148-5c350d0d3c56?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&h=630&q=80">
    <meta name="twitter:creator" content="@optifind">
    
    <!-- Google Analytics (free - replace ID) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-XXXXXXXXXX'); // REPLACE WITH YOUR GA ID
    </script>
    
    <style>
        /* ========== CSS VARIABLES ========== */
        :root {
            --soft-blue: #6C8EF5;
            --light-blue: #A8C6FF;
            --cool-grey: #F5F7FA;
            --dark-grey: #4A5568;
            --white: #FFFFFF;
            --shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            --radius: 12px;
        }

        /* ========== GLOBAL STYLES ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--cool-grey);
            color: var(--dark-grey);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* ========== HEADER ========== */
        header {
            background-color: var(--white);
            padding: 20px 0;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 28px;
            color: var(--soft-blue);
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .logo i {
            margin-right: 10px;
            font-size: 24px;
        }

        /* ========== MAIN CONTENT ========== */
        .main-content {
            min-height: calc(100vh - 140px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 40px 0;
        }

        /* ========== WELCOME SCREEN ========== */
        .welcome-screen {
            text-align: center;
        }

        .main-title {
            font-family: 'Poppins', sans-serif;
            font-size: 48px;
            font-weight: 700;
            color: var(--soft-blue);
            margin-bottom: 15px;
        }

        .subtext {
            font-size: 20px;
            color: var(--dark-grey);
            margin-bottom: 60px;
            font-weight: 300;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            margin-top: 20px;
        }

        .option-card {
            background-color: var(--white);
            border-radius: var(--radius);
            padding: 30px 20px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 2px solid transparent;
        }

        .option-card:hover {
            transform: translateY(-10px);
            border-color: var(--light-blue);
        }

        .option-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: var(--light-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .option-icon i {
            font-size: 30px;
            color: var(--soft-blue);
        }

        .option-card h3 {
            font-size: 22px;
            color: var(--dark-grey);
            margin-bottom: 10px;
        }

        .option-card p {
            color: #718096;
            text-align: center;
            font-size: 15px;
        }

        /* ========== QUESTION FLOW PAGE ========== */
        .question-screen {
            max-width: 800px;
            margin: 0 auto;
            display: none;
        }

        .progress-bar {
            height: 6px;
            background-color: #E2E8F0;
            border-radius: 3px;
            margin-bottom: 40px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background-color: var(--soft-blue);
            width: 20%;
            transition: width 0.5s ease;
        }

        .question-container {
            background-color: var(--white);
            border-radius: var(--radius);
            padding: 40px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .question-number {
            color: var(--soft-blue);
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .question-text {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 30px;
            color: var(--dark-grey);
        }

        .options-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .option-btn {
            background-color: var(--cool-grey);
            border: none;
            padding: 18px 15px;
            border-radius: var(--radius);
            font-size: 16px;
            color: var(--dark-grey);
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .option-btn:hover {
            background-color: var(--light-blue);
            color: var(--white);
        }

        .option-btn.selected {
            background-color: var(--soft-blue);
            color: var(--white);
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
        }

        .nav-btn {
            padding: 12px 30px;
            border-radius: var(--radius);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            font-weight: 500;
        }

        .nav-btn.back {
            background-color: transparent;
            color: var(--dark-grey);
        }

        .nav-btn.back:hover {
            background-color: #EDF2F7;
        }

        .nav-btn.next {
            background-color: var(--soft-blue);
            color: var(--white);
        }

        .nav-btn.next:hover {
            background-color: #5A7AF0;
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(245, 247, 250, 0.95);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    display: none;
}

.loading-spinner {
    width: 60px;
    height: 60px;
    border: 5px solid #E2E8F0;
    border-top-color: var(--soft-blue);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading-text {
    margin-top: 20px;
    font-size: 18px;
    color: var(--dark-grey);
    font-weight: 500;
}

        /* ========== PERSONALITY BADGE ========== */
        .personality-badge {
            display: inline-block;
            background: linear-gradient(135deg, #6C8EF5, #A8C6FF);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 16px;
            margin: 10px 0 20px;
            box-shadow: 0 4px 12px rgba(108, 142, 245, 0.3);
        }

        /* ========== FEEDBACK MODAL ========== */
        .feedback-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }

        .feedback-content {
            background-color: var(--white);
            border-radius: var(--radius);
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .feedback-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        /* ========== RECOMMENDATION PAGE ========== */
        .recommendation-screen {
            max-width: 700px;
            margin: 0 auto;
            text-align: center;
            display: none;
        }

        .recommendation-card {
            background-color: var(--white);
            border-radius: var(--radius);
            padding: 50px 40px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            position: relative;
        }

        .recommendation-logo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: var(--light-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            overflow: hidden;
        }

        .recommendation-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .recommendation-title {
            font-family: 'Poppins', sans-serif;
            font-size: 36px;
            font-weight: 700;
            color: var(--dark-grey);
            margin-bottom: 10px;
        }

        .recommendation-author {
            font-size: 18px;
            color: #718096;
            margin-bottom: 30px;
            font-style: italic;
        }

        .recommendation-tagline {
            font-size: 20px;
            color: var(--dark-grey);
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .match-reasons {
            background-color: var(--cool-grey);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 30px;
            text-align: left;
        }

        .match-reasons h3 {
            font-size: 18px;
            color: var(--soft-blue);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .match-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .match-tag {
            background-color: var(--soft-blue);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        /* Improve color contrast */
.match-tag {
    background-color: #5A7AF0; /* Darker shade for better contrast */
}

/* Add focus styles */
button:focus {
    outline: 2px solid #4A5568;
    outline-offset: 2px;
}

        .personality-insight {
            background: linear-gradient(135deg, #F5F7FA, #E2E8F0);
            border-radius: var(--radius);
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid var(--soft-blue);
            text-align: left;
        }

        .personality-insight h4 {
            color: var(--soft-blue);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .try-message {
            font-size: 22px;
            color: var(--soft-blue);
            font-weight: 600;
            margin-bottom: 40px;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .action-btn {
            padding: 14px 30px;
            border-radius: var(--radius);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .action-btn.primary {
            background-color: var(--soft-blue);
            color: var(--white);
        }

        .action-btn.primary:hover {
            background-color: #5A7AF0;
        }

        .action-btn.secondary {
            background-color: transparent;
            color: var(--dark-grey);
            border: 1px solid #CBD5E0;
        }

        
.action-btn.saved {
    background-color: #52BE80;
    color: white;
}

.action-btn.saved:hover {
    background-color: #45a86f;
}

        .action-btn.secondary:hover {
            background-color: #EDF2F7;
        }

        .action-btn.tertiary {
            background-color: transparent;
            color: var(--soft-blue);
            border: 1px solid var(--soft-blue);
        }

        .action-btn.tertiary:hover {
            background-color: rgba(108, 142, 245, 0.1);
        }

        .social-share {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .social-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            font-size: 18px;
            color: white;
        }

        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.whatsapp { background-color: #25D366; }
        .social-btn.reddit { background-color: #FF4500; }
        .social-btn.link { background-color: var(--dark-grey); }

        .social-btn:hover {
            transform: translateY(-3px);
            opacity: 0.9;
        }

        /* ========== TOAST NOTIFICATION ========== */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--soft-blue);
            color: white;
            padding: 15px 25px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 10000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* ========== SAVED RECOMMENDATIONS ========== */
        .saved-recommendations {
            position: fixed;
            top: 80px;
            right: 20px;
            background-color: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            z-index: 99;
        }

        .saved-recommendations.show {
            display: block;
        }

        .saved-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #E2E8F0;
        }

        .saved-item {
            padding: 10px;
            border-radius: var(--radius);
            background-color: var(--cool-grey);
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .saved-item:hover {
            background-color: #E2E8F0;
        }

        .save-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: var(--soft-blue);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            display: none;
        }

        .save-indicator:hover {
            transform: scale(1.1);
        }

        /* ========== DROPDOWN MENU STYLES (MISSING) ========== */
.three-dots-menu {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    color: #718096;
    cursor: pointer;
    padding: 5px;
    border-radius: 4px;
    z-index: 2;
}

.three-dots-menu:hover {
    background-color: rgba(0, 0, 0, 0.05);
}

.dropdown-menu {
    position: absolute;
    top: 35px;
    right: 10px;
    background-color: var(--white);
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    padding: 8px 0;
    min-width: 120px;
    display: none;
    z-index: 100;
}

.dropdown-menu.show {
    display: block;
}

.dropdown-item {
    width: 100%;
    padding: 8px 16px;
    border: none;
    background: none;
    text-align: left;
    color: var(--dark-grey);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
}

.dropdown-item:hover {
    background-color: var(--cool-grey);
}

.dropdown-item.delete {
    color: #E53E3E;
}

.dropdown-item.delete:hover {
    background-color: rgba(229, 62, 62, 0.1);
}

/* Fix for feedback modal display issue */
.feedback-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: none; /* Fixed: removed duplicate display property */
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

/* Make saved items cards and items relative for dropdown positioning */
.saved-item-card {
    position: relative; /* Add this */
    background-color: var(--white);
    border-radius: var(--radius);
    padding: 15px;
    box-shadow: var(--shadow);
    cursor: pointer;
    transition: all 0.2s ease;
    border-left: 4px solid var(--soft-blue);
}

.saved-item {
    position: relative; /* Add this */
    padding: 10px;
    border-radius: var(--radius);
    background-color: var(--cool-grey);
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
}

        /* ========== SAVED ITEMS GRID ON HOMEPAGE ========== */
        .saved-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .saved-item-card {
            background-color: var(--white);
            border-radius: var(--radius);
            padding: 15px;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 4px solid var(--soft-blue);
        }

        .saved-item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .saved-item-category {
            font-size: 12px;
            color: var(--soft-blue);
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .saved-item-name {
            font-weight: 600;
            color: var(--dark-grey);
            margin-bottom: 5px;
            font-size: 14px;
        }

        .saved-item-date {
            font-size: 11px;
            color: #718096;
        }

        /* ========== FOOTER ========== */
        footer {
            background-color: var(--white);
            padding: 30px 0;
            text-align: center;
            color: #718096;
            font-size: 14px;
            margin-top: 40px;
            border-top: 1px solid #E2E8F0;
        }

        /* ========== RESPONSIVE STYLES ========== */
        @media (max-width: 768px) {
            .main-title { font-size: 36px; }
            .subtext { font-size: 18px; margin-bottom: 40px; }
            .options-grid { grid-template-columns: 1fr; max-width: 400px; margin: 0 auto; }
            .question-container { padding: 30px 20px; }
            .question-text { font-size: 20px; }
            .recommendation-title { font-size: 28px; }
            .recommendation-card { padding: 40px 20px; }
            .action-buttons { flex-direction: column; }
            .action-btn { width: 100%; }
            .saved-recommendations {
                position: fixed;
                top: auto;
                bottom: 0;
                right: 0;
                left: 0;
                width: 100%;
                border-radius: var(--radius) var(--radius) 0 0;
                max-height: 50vh;
            }
            .save-indicator { top: 10px; right: 10px; }
            .feedback-buttons { flex-direction: column; }
        }

        @media (max-width: 480px) {
            .main-title { font-size: 30px; }
            .subtext { font-size: 16px; }
            .option-card { padding: 25px 15px; }
            .options-container { grid-template-columns: 1fr; }
            .navigation-buttons { flex-direction: column; gap: 15px; }
            .nav-btn { width: 100%; }
        }
        @media (max-width: 380px) {
    .option-btn {
        padding: 15px 10px;
        font-size: 14px;
    }
    .question-text {
        font-size: 18px;
    }
    .progress-bar {
        height: 4px;
    }
    .saved-recommendations {
        max-height: 40vh;
    }
}

/* Add focus styles for accessibility */
.option-btn:focus,
.nav-btn:focus,
.action-btn:focus {
    outline: 2px solid var(--soft-blue);
    outline-offset: 2px;
}
    </style>
</head>

<body>
    <!-- ========== HEADER ========== -->
    <header>
        <div class="container">
            <div class="logo" id="logo">
                <i class="fas fa-search"></i> OptiFind
            </div>
        </div>
    </header>

    <!-- ========== MAIN CONTENT ========== -->
    <div class="main-content">
        <!-- Welcome Screen -->
         
        <div class="container welcome-screen" id="welcomeScreen">
            <h1 class="main-title">OptiFind</h1>
            <p class="subtext">Find the best choice for you.</p>

            <div style="max-width: 600px; margin: 0 auto 40px; background: linear-gradient(135deg, #6C8EF5, #A8C6FF); padding: 15px 25px; border-radius: var(--radius); color: white;">
    <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
        <span style="font-size: 24px;">‚ö°</span>
        <span style="font-weight: 500;">Takes 30 seconds ‚Ä¢ 3 questions ‚Ä¢ 100% free</span>
    </div>
</div>
            
            <div class="options-grid">
                <div class="option-card" data-option="books">
                    <div class="option-icon"><i class="fas fa-book"></i></div>
                    <h3>Books to Buy</h3>
                    <p>Find your next great read</p>
                </div>
                
                <div class="option-card" data-option="courses">
                    <div class="option-icon"><i class="fas fa-graduation-cap"></i></div>
                    <h3>Courses</h3>
                    <p>Discover the best courses to advance your career</p>
                </div>
                
                <div class="option-card" data-option="apps">
                    <div class="option-icon"><i class="fas fa-mobile-alt"></i></div>
                    <h3>Apps to Use</h3>
                    <p>Get recommendations for useful applications</p>
                </div>
                
                <div class="option-card" data-option="skills">
                    <div class="option-icon"><i class="fas fa-lightbulb"></i></div>
                    <h3>Skills to Learn</h3>
                    <p>Find skills that will make you more valuable</p>
                </div>
            </div>

            <!-- Add this after the main options grid (around line 920) -->
<div id="quickReturnSection" style="display: none; margin-top: 40px; text-align: center;">
    <h3 style="color: var(--dark-grey); margin-bottom: 15px;">
        Welcome back! Want more <span id="lastCategoryName">book</span> recommendations?
    </h3>
    <button class="action-btn primary" id="quickReturnBtn">
        <i class="fas fa-redo"></i> Get Another Recommendation
    </button>
</div>

          <!-- Stats -->
<div id="statsDisplay" style="margin-top: 40px;">
    <div style="display: flex; justify-content: center; gap: 30px; flex-wrap: wrap;">
        <div style="background: var(--white); padding: 20px 30px; border-radius: var(--radius); box-shadow: var(--shadow); text-align: center;">
            <div style="font-size: 32px; font-weight: 700; color: var(--soft-blue);" id="totalRecommendations">0</div>
            <div style="font-size: 14px; color: #718096;">Recommendations Given</div>
        </div>
        <div style="background: var(--white); padding: 20px 30px; border-radius: var(--radius); box-shadow: var(--shadow); text-align: center;">
            <div style="font-size: 32px; font-weight: 700; color: #52BE80;" id="totalSaves">0</div>
            <div style="font-size: 14px; color: #718096;">Items Saved</div>
        </div>
        <div style="background: var(--white); padding: 20px 30px; border-radius: var(--radius); box-shadow: var(--shadow); text-align: center;">
            <div style="font-size: 32px; font-weight: 700; color: #FFA726;">4.8‚òÖ</div>
            <div style="font-size: 14px; color: #718096;">User Rating</div>
        </div>
    </div>
</div>
            <!-- Recent Recommendations -->
            <div class="recent-recommendations" id="recentRecommendations" style="display: none; margin-top: 50px;">
                <h3 style="color: var(--dark-grey); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-history"></i> Your Recent Recommendations
                </h3>
                <div class="saved-items-grid" id="savedItemsGrid">
                    <!-- Saved items will appear here -->
                </div>
                <div class="view-all-saved" style="margin-top: 20px;">
                    <button class="action-btn secondary" id="viewAllSavedBtn" style="padding: 10px 20px; font-size: 14px;">
                        <i class="fas fa-bookmark"></i> View All Saved Recommendations
                    </button>
                </div>
            </div>

            <!-- Invite Friends -->
            <div id="inviteFriends" style="margin-top: 40px; display: none;">
                <div style="background: linear-gradient(135deg, var(--soft-blue), var(--light-blue)); color: white; padding: 20px; border-radius: var(--radius); text-align: center;">
                    <h3 style="margin-bottom: 10px;"><i class="fas fa-users"></i> Invite Friends</h3>
                    <p style="margin-bottom: 15px; opacity: 0.9;">Share OptiFind and unlock special recommendations</p>
                    <button class="action-btn" id="inviteBtn" style="background: white; color: var(--soft-blue);">
                        <i class="fas fa-share-alt"></i> Share with Friends
                    </button>
                </div>
            </div>
        </div>

        <!-- Question Flow Page -->
        <div class="container question-screen" id="questionScreen">
            <div class="progress-bar">
                <div class="progress" id="progressBar"></div>
            </div>
            
            <div class="question-container">
                <div class="question-number" id="questionNumber">Question 1 of 3</div>
                <h2 class="question-text" id="questionText"></h2>
                
                <div class="options-container" id="optionsContainer">
                    <!-- Options will be dynamically added here -->
                </div>
            </div>
            
            <div class="navigation-buttons">
                <button class="nav-btn back" id="backBtn" disabled>
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <button class="nav-btn next" id="nextBtn" disabled>
                    Next <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Recommendation Page -->
        <div class="container recommendation-screen" id="recommendationScreen">
            <div class="save-indicator" id="saveIndicator" title="Save this recommendation">
                <i class="fas fa-bookmark"></i>
            </div>
            
            <div class="recommendation-card">
                <!-- Personality Badge -->
                <div class="personality-badge" id="personalityBadge"></div>
                
                <div class="recommendation-logo" id="recommendationLogo">
                    <!-- Image will be loaded here -->
                </div>
                
                <h1 class="recommendation-title" id="recommendationTitle"></h1>
                <div class="recommendation-author" id="recommendationAuthor"></div>
                <p class="recommendation-tagline" id="recommendationTagline"></p>
                
                <!-- Personality Insight -->
                <div class="personality-insight" id="personalityInsight">
                    <h4><i class="fas fa-brain"></i> What this says about you:</h4>
                    <p id="insightText"></p>
                </div>
                
                <div class="match-reasons" id="matchReasons">
                    <h3><i class="fas fa-check-circle"></i> Why we recommended this:</h3>
                    <div class="match-tags" id="matchTags">
                        <!-- Matched tags will appear here -->
                    </div>
                </div>
                
                <div class="try-message">Go try it out.</div>
                
                <div class="action-buttons">
                    <button class="action-btn primary" id="findMoreBtn">
                        <i class="fas fa-search"></i> Find More Recommendations
                    </button>
                    <button class="action-btn secondary" id="retryBtn">
                        <i class="fas fa-redo"></i> Adjust My Answers
                    </button>
                    <button class="action-btn tertiary" id="saveBtn">
                        <i class="fas fa-bookmark"></i> Save Recommendation
                    </button>
                </div>
                
                <div class="action-buttons">
                    <button class="action-btn primary" id="shareBtn">
                        <i class="fas fa-share-alt"></i> Share My Result
                    </button>
                    <button class="action-btn secondary" id="viewSavedBtn">
                        <i class="fas fa-history"></i> View Saved (<span id="savedCount">0</span>)
                    </button>
                </div>
                
                <!-- Social Share Buttons -->
                <div class="social-share" id="socialShare">
                    <button class="social-btn twitter" data-platform="twitter"><i class="fab fa-twitter"></i></button>
                    <button class="social-btn facebook" data-platform="facebook"><i class="fab fa-facebook-f"></i></button>
                    <button class="social-btn linkedin" data-platform="linkedin"><i class="fab fa-linkedin-in"></i></button>
                    <button class="social-btn whatsapp" data-platform="whatsapp"><i class="fab fa-whatsapp"></i></button>
                    <button class="social-btn reddit" data-platform="reddit"><i class="fab fa-reddit-alien"></i></button>
                    <button class="social-btn link" id="copyLinkBtn"><i class="fas fa-link"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== FEEDBACK MODAL ========== -->
    <div class="feedback-modal" id="feedbackModal">
        <div class="feedback-content">
            <h2 style="color: var(--soft-blue); margin-bottom: 15px;">How accurate was this?</h2>
            <p style="margin-bottom: 20px;">Help us improve by sharing your experience</p>
            
            <div class="feedback-buttons">
                <button class="action-btn primary" id="feedbackAccurate">
                    <i class="fas fa-check-circle"></i> Spot on! 
                </button>
                <button class="action-btn secondary" id="feedbackNeutral">
                    <i class="fas fa-meh"></i> Could be better
                </button>
                <button class="action-btn secondary" id="feedbackSkip">
                    Skip
                </button>
            </div>
        </div>
    </div>

    <!-- ========== SHARE TO UNLOCK MODAL (P0) ========== -->
    <div class="feedback-modal" id="shareUnlockModal" style="display:none;">
        <div class="feedback-content">
            <h2 style="color: var(--soft-blue); margin-bottom: 15px;">Unlock More Recommendations</h2>
            <p style="margin-bottom: 20px;">Share your result to unlock 3 extra categories and a tailored recommendation.</p>
            <div class="feedback-buttons">
                <button class="action-btn primary" id="shareUnlockBtn"><i class="fas fa-share-alt"></i> Share & Unlock</button>
                <button class="action-btn secondary" id="skipShareUnlock">Maybe later</button>
            </div>
        </div>
    </div>

    <!-- ========== SAVED RECOMMENDATIONS PANEL ========== -->
    <div class="saved-recommendations" id="savedPanel">
        <div class="saved-header">
            <h3><i class="fas fa-bookmark"></i> Saved Recommendations</h3>
            <button class="action-btn secondary" id="closeSavedBtn" style="padding: 5px 10px; font-size: 14px;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="savedItems">
            <!-- Saved items will appear here -->
        </div>
    </div>

    <!-- ========== TOAST NOTIFICATION ========== -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage"></span>
    </div>

    <!-- ========== FOOTER ========== -->
    <footer>
        <div class="container">
            <p>√Ç¬© 2025 OptiFind. All rights reserved.</p>
            <p>Helping you make better decisions, one recommendation at a time.</p>
            <p style="margin-top: 10px; font-size: 12px; color: #CBD5E0;">
                <span id="totalUsers">0</span> users helped | 
                <span id="footerTotalSaves">0</span> recommendations saved
            </p>
        </div>
    </footer>

<script>
    // ========== ENHANCED DATASET WITH PERSONALITY MAPPING ==========
    const itemsDataset = [
        {
            "id": 1,
            "name": "Atomic Habits",
            "image": "https://images-na.ssl-images-amazon.com/images/I/81YkqyaFVEL.jpg",
            "tags": ["books", "non-fiction", "self-improvement", "productivity", "habits", "practical", "actionable"],
            "author": "by James Clear",
            "tagline": "Tiny Changes, Remarkable Results",
            "icon": "fas fa-book",
            "color": "#6C8EF5",
            "personality": "The Productivity Pragmatist",
            "insight": "You value practical, actionable advice over theoretical concepts. You're likely someone who prefers clear systems and measurable progress."
        },
        {
            "id": 2,
            "name": "The Creative Act",
            "image": "https://images-na.ssl-images-amazon.com/images/I/71fWBj8q+kL.jpg",
            "tags": ["books", "non-fiction", "creativity", "arts", "inspiration", "creative-process"],
            "author": "by Rick Rubin",
            "tagline": "A Way of Being",
            "icon": "fas fa-paint-brush",
            "color": "#FF6B6B",
            "personality": "The Creative Dreamer",
            "insight": "You're drawn to artistic expression and value intuition over strict methodology. You likely enjoy exploring ideas without immediate practical application."
        },
        {
            "id": 3,
            "name": "Thinking, Fast and Slow",
            "image": "https://images-na.ssl-images-amazon.com/images/I/71wv0KfG01L.jpg",
            "tags": ["books", "non-fiction", "psychology", "decision-making", "cognitive-science", "analytical"],
            "author": "by Daniel Kahneman",
            "tagline": "Understanding how your mind works",
            "icon": "fas fa-brain",
            "color": "#52BE80",
            "personality": "The Analytical Strategist",
            "insight": "You enjoy understanding the 'why' behind decisions. You're likely methodical and value evidence-based approaches over gut feelings."
        },
        {
            "id": 4,
            "name": "Sapiens: A Brief History of Humankind",
            "image": "https://images-na.ssl-images-amazon.com/images/I/713jIoMO3UL.jpg",
            "tags": ["books", "non-fiction", "history", "anthropology", "big-picture", "academic"],
            "author": "by Yuval Noah Harari",
            "tagline": "From Animals to Gods",
            "icon": "fas fa-globe",
            "color": "#9B59B6",
            "personality": "The Intellectual Explorer",
            "insight": "You're curious about systems and patterns on a grand scale. You likely enjoy connecting dots across disciplines and understanding how things fit together."
        },
        {
            "id": 5,
            "name": "Coursera - Learning How to Learn",
            "image": "https://images.unsplash.com/photo-1501504905252-473c47e087f8?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80",
            "tags": ["courses", "learning", "productivity", "skills", "free", "beginner-friendly"],
            "author": "University of California San Diego",
            "tagline": "Master powerful mental tools to help you master tough subjects",
            "icon": "fas fa-graduation-cap",
            "color": "#3498DB",
            "personality": "The Efficient Learner",
            "insight": "You value optimizing processes and want to learn how to learn better. You're likely systematic and interested in meta-skills."
        },
        {
            "id": 6,
            "name": "Udemy - Complete Python Bootcamp",
            "image": "https://images.unsplash.com/photo-1526379879527-8559ecfcaec5?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80",
            "tags": ["courses", "programming", "python", "technical-skills", "career-growth", "hands-on"],
            "author": "Jose Portilla",
            "tagline": "Go from zero to hero in Python",
            "icon": "fas fa-code",
            "color": "#FFA726",
            "personality": "The Practical Builder",
            "insight": "You prefer learning skills with immediate practical applications. You're likely career-oriented and value tangible results."
        },
        {
            "id": 7,
            "name": "Notion",
            "image": "https://images.unsplash.com/photo-1611224923853-80b023f02d71?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80",
            "tags": ["apps", "productivity", "organization", "free", "all-in-one", "note-taking"],
            "author": "Notion Labs",
            "tagline": "All-in-one workspace",
            "icon": "fas fa-sticky-note",
            "color": "#000000",
            "personality": "The Organized Optimizer",
            "insight": "You value systems and organization. You likely enjoy customizing tools to fit your workflow perfectly."
        },
        {
            "id": 8,
            "name": "Duolingo",
            "image": "https://images.unsplash.com/photo-1535223289827-42f1e9919769?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80",
            "tags": ["apps", "learning", "languages", "free", "gamified", "daily-habit"],
            "author": "Duolingo",
            "tagline": "Learn a language for free",
            "icon": "fas fa-language",
            "color": "#58CC02",
            "personality": "The Consistent Improver",
            "insight": "You enjoy building habits through small, consistent actions. You likely appreciate gamification and clear progress tracking."
        },
        {
            "id": 9,
            "name": "Communication Skills",
            "image": "https://images.unsplash.com/photo-1544717305-99670f9c28f1?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80",
            "tags": ["skills", "soft-skills", "communication", "leadership", "career-growth", "essential"],
            "author": "Essential Skill",
            "tagline": "Master the art of effective communication",
            "icon": "fas fa-comments",
            "color": "#9C27B0",
            "personality": "The Social Connector",
            "insight": "You understand that technical skills alone aren't enough. You value human connection and emotional intelligence in professional settings."
        },
        {
            "id": 10,
            "name": "Data Analysis Fundamentals",
            "image": "https://images.unsplash.com/photo-1551288049-bebda4e38f71?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80",
            "tags": ["skills", "technical-skills", "data", "analytical", "in-demand", "career-growth"],
            "author": "High-Value Skill",
            "tagline": "Turn data into insights",
            "icon": "fas fa-chart-line",
            "color": "#00BCD4",
            "personality": "The Data-Driven Decision Maker",
            "insight": "You trust evidence over intuition and enjoy finding patterns in information. You're likely strategic and future-oriented in your career planning."
        }
    ];

    // ========== PERSONALITY ARCHETYPES ==========
    const personalityArchetypes = {
        "The Productivity Pragmatist": {
            description: "You value efficiency, systems, and measurable results. Practical solutions beat theoretical concepts.",
            emoji: "‚ö°",
            color: "#6C8EF5"
        },
        "The Creative Dreamer": {
            description: "You're drawn to artistic expression, intuition, and exploring ideas without immediate practical application.",
            emoji: "üé®",
            color: "#FF6B6B"
        },
        "The Analytical Strategist": {
            description: "You enjoy understanding the 'why' behind decisions and value evidence-based approaches.",
            emoji: "üîç",
            color: "#52BE80"
        },
        "The Intellectual Explorer": {
            description: "You're curious about systems and patterns on a grand scale, connecting dots across disciplines.",
            emoji: "üåç",
            color: "#9B59B6"
        },
        "The Efficient Learner": {
            description: "You value optimizing processes and want to learn how to learn better through systematic approaches.",
            emoji: "üìö",
            color: "#3498DB"
        },
        "The Practical Builder": {
            description: "You prefer skills with immediate practical applications and tangible career results.",
            emoji: "üõ†Ô∏è",
            color: "#FFA726"
        },
        "The Organized Optimizer": {
            description: "You value systems, organization, and customizing tools to fit your workflow perfectly.",
            emoji: "üóÇÔ∏è",
            color: "#34495E"
        },
        "The Consistent Improver": {
            description: "You enjoy building habits through small, consistent actions with clear progress tracking.",
            emoji: "üìà",
            color: "#58CC02"
        },
        "The Social Connector": {
            description: "You understand that human connection and emotional intelligence are essential professional skills.",
            emoji: "ü§ù",
            color: "#9C27B0"
        },
        "The Data-Driven Decision Maker": {
            description: "You trust evidence over intuition and enjoy finding strategic patterns in information.",
            emoji: "üìä",
            color: "#00BCD4"
        }
    };

    // ========== ENHANCED QUESTION MAPPING ==========
    const questionsData = {
        books: [
            {
                question: "What type of book resonates with you most?",
                options: ["Practical guides with actionable steps", "Creative works that inspire imagination", "Analytical books that explain systems", "Historical perspectives on big ideas"],
                tags: ["practical", "creative", "analytical", "big-picture"],
                weights: [1.0, 0.8, 0.9, 0.7]
            },
            {
                question: "When you read, what's your main goal?",
                options: ["Solve a specific problem", "Escape and be entertained", "Understand how something works", "Expand my worldview"],
                tags: ["problem-solving", "entertainment", "understanding", "expansion"],
                weights: [1.0, 0.6, 0.9, 0.8]
            },
            {
                question: "How do you prefer to consume information?",
                options: ["Step-by-step frameworks", "Stories and narratives", "Data and evidence", "Theories and concepts"],
                tags: ["frameworks", "stories", "data", "concepts"],
                weights: [1.0, 0.7, 0.9, 0.8]
            }
        ],
        courses: [
            {
                question: "What's your learning priority?",
                options: ["Gain practical skills quickly", "Explore creative expression", "Understand theoretical foundations", "Learn high-level concepts"],
                tags: ["practical-skills", "creative", "theoretical", "conceptual"],
                weights: [1.0, 0.8, 0.9, 0.7]
            },
            {
                question: "How do you measure learning success?",
                options: ["Can apply it immediately", "Feel inspired or creative", "Understand the underlying principles", "Can explain it to others"],
                tags: ["application", "inspiration", "principles", "explanation"],
                weights: [1.0, 0.7, 0.9, 0.8]
            },
            {
                question: "What learning format works best?",
                options: ["Hands-on projects", "Creative assignments", "Case studies and analysis", "Lectures and reading"],
                tags: ["hands-on", "creative", "analytical", "academic"],
                weights: [1.0, 0.8, 0.9, 0.7]
            }
        ],
        apps: [
            {
                question: "What do you value most in an app?",
                options: ["Saves time and increases efficiency", "Enables creative expression", "Provides data and insights", "Helps organize information"],
                tags: ["efficiency", "creativity", "insights", "organization"],
                weights: [1.0, 0.8, 0.9, 0.8]
            },
            {
                question: "How do you prefer to interact with apps?",
                options: ["Quick, task-focused interfaces", "Beautiful, inspiring designs", "Data-rich dashboards", "Customizable workspaces"],
                tags: ["task-focused", "design-focused", "data-focused", "customizable"],
                weights: [1.0, 0.7, 0.9, 0.8]
            },
            {
                question: "What's your main app usage pattern?",
                options: ["Daily productivity tools", "Creative/social expression", "Analytical decision-making", "Information management"],
                tags: ["productivity", "expression", "decision-making", "management"],
                weights: [1.0, 0.8, 0.9, 0.8]
            }
        ],
        skills: [
            {
                question: "What drives your skill learning?",
                options: ["Career advancement and ROI", "Personal passion and enjoyment", "Understanding complex systems", "Intellectual curiosity"],
                tags: ["career", "passion", "systems", "curiosity"],
                weights: [1.0, 0.8, 0.9, 0.7]
            },
            {
                question: "How do you approach learning new skills?",
                options: ["Structured, goal-oriented plans", "Experimental, playful exploration", "Analytical breakdown of components", "Theoretical understanding first"],
                tags: ["structured", "experimental", "analytical", "theoretical"],
                weights: [1.0, 0.7, 0.9, 0.8]
            },
            {
                question: "What's your preferred learning outcome?",
                options: ["Master a specific technique", "Develop a creative style", "Understand underlying patterns", "Gain broad conceptual knowledge"],
                tags: ["technique", "style", "patterns", "knowledge"],
                weights: [1.0, 0.8, 0.9, 0.7]
            }
        ]
    };

    // ========== ENHANCED APPLICATION STATE ==========
    const state = {
        currentScreen: 'welcome',
        selectedOption: null,
        currentQuestionIndex: 0,
        userAnswers: [],
        userTags: [],
        userPersonality: null,
        questionWeights: [],
        questions: [],
        recommendation: null,
        matchedTags: [],
        savedRecommendations: [],
        analytics: {
            totalRecommendations: 0,
            totalSaves: 0,
            feedbackAccurate: 0,
            feedbackNeutral: 0,
            shares: 0
        },
        userId: null,
        referralCode: null
    };

    // ========== DOM ELEMENTS ==========
    const welcomeScreen = document.getElementById('welcomeScreen');
    const questionScreen = document.getElementById('questionScreen');
    const recommendationScreen = document.getElementById('recommendationScreen');
    const progressBar = document.getElementById('progressBar');
    const questionNumber = document.getElementById('questionNumber');
    const questionText = document.getElementById('questionText');
    const optionsContainer = document.getElementById('optionsContainer');
    const backBtn = document.getElementById('backBtn');
    const nextBtn = document.getElementById('nextBtn');
    const recommendationTitle = document.getElementById('recommendationTitle');
    const recommendationAuthor = document.getElementById('recommendationAuthor');
    const recommendationTagline = document.getElementById('recommendationTagline');
    const recommendationLogo = document.getElementById('recommendationLogo');
    const personalityBadge = document.getElementById('personalityBadge');
    const personalityInsight = document.getElementById('personalityInsight');
    const insightText = document.getElementById('insightText');
    const matchReasons = document.getElementById('matchReasons');
    const matchTags = document.getElementById('matchTags');
    const findMoreBtn = document.getElementById('findMoreBtn');
    const retryBtn = document.getElementById('retryBtn');
    const saveBtn = document.getElementById('saveBtn');
    const shareBtn = document.getElementById('shareBtn');
    const viewSavedBtn = document.getElementById('viewSavedBtn');
    const savedCount = document.getElementById('savedCount');
    const socialShare = document.getElementById('socialShare');
    const copyLinkBtn = document.getElementById('copyLinkBtn');
    const saveIndicator = document.getElementById('saveIndicator');
    const savedPanel = document.getElementById('savedPanel');
    const savedItems = document.getElementById('savedItems');
    const closeSavedBtn = document.getElementById('closeSavedBtn');
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    const logo = document.getElementById('logo');
    const viewAllSavedBtn = document.getElementById('viewAllSavedBtn');
    const recentRecommendations = document.getElementById('recentRecommendations');
    const savedItemsGrid = document.getElementById('savedItemsGrid');
    const feedbackModal = document.getElementById('feedbackModal');
    const feedbackAccurate = document.getElementById('feedbackAccurate');
    const feedbackNeutral = document.getElementById('feedbackNeutral');
    const feedbackSkip = document.getElementById('feedbackSkip');
    const statsDisplay = document.getElementById('statsDisplay');
    const totalRecommendations = document.getElementById('totalRecommendations');
    const totalUsers = document.getElementById('totalUsers');
    const totalSaves = document.getElementById('totalSaves');
    const inviteFriends = document.getElementById('inviteFriends');
    const inviteBtn = document.getElementById('inviteBtn');
    const shareUnlockModal = document.getElementById('shareUnlockModal');
    const shareUnlockBtn = document.getElementById('shareUnlockBtn');
    const skipShareUnlock = document.getElementById('skipShareUnlock');

    // ========== EVENT LISTENERS ==========
    document.addEventListener('DOMContentLoaded', initApp);
    
    document.querySelectorAll('.option-card').forEach(card => {
        card.addEventListener('click', () => {
            const option = card.getAttribute('data-option');
            selectOption(option);
        });
    });

    backBtn.addEventListener('click', goToPreviousQuestion);
    nextBtn.addEventListener('click', goToNextQuestion);
    findMoreBtn.addEventListener('click', () => {
        resetState();
        showScreen('welcome');
    });
    retryBtn.addEventListener('click', retryQuestions);
    saveBtn.addEventListener('click', handleSaveButtonClick);
    saveIndicator.addEventListener('click', handleSaveButtonClick);
    viewSavedBtn.addEventListener('click', toggleSavedPanel);
    closeSavedBtn.addEventListener('click', toggleSavedPanel);
    logo.addEventListener('click', () => showScreen('welcome'));
    
    viewAllSavedBtn.addEventListener('click', () => {
        showScreen('recommendation');
        toggleSavedPanel();
    });

    document.querySelectorAll('.social-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const platform = this.getAttribute('data-platform');
            if (platform === 'link' || this.id === 'copyLinkBtn') {
                copyRecommendationLink();
            } else {
                shareOnPlatform(platform);
            }
        });
    });

    document.addEventListener('click', (e) => {
        if (!savedPanel.contains(e.target) && !viewSavedBtn.contains(e.target)) {
            savedPanel.classList.remove('show');
        }
    });

    // Feedback events
    feedbackAccurate.addEventListener('click', () => submitFeedback('accurate'));
    feedbackNeutral.addEventListener('click', () => submitFeedback('neutral'));
    feedbackSkip.addEventListener('click', () => feedbackModal.style.display = 'none');

    // Invite friends
    inviteBtn.addEventListener('click', inviteFriendsFunction);

    // Share Unlock events
    shareUnlockBtn.addEventListener('click', handleShareUnlock);
    skipShareUnlock.addEventListener('click', () => {
        shareUnlockModal.style.display = 'none';
        localStorage.setItem('optifind_shared_unlock_skipped', 'true');
    });

    // ========== P0: FIXED trackEvent FUNCTION ==========
    function trackEvent(eventName, properties = {}) {
        try {
            const event = {
                event: eventName,
                properties: Object.assign({}, properties, {
                    userId: state.userId,
                    timestamp: new Date().toISOString(),
                    screen: state.currentScreen,
                    personality: state.userPersonality,
                    category: state.selectedOption
                })
            };

            let events = JSON.parse(localStorage.getItem('optifind_events') || '[]');
            events.push(event);
            if (events.length > 500) events = events.slice(-500);
            localStorage.setItem('optifind_events', JSON.stringify(events));

            // Google Analytics (if configured)
            if (typeof gtag !== 'undefined') {
                try { gtag('event', eventName, event.properties); } catch (e) { /* ignore */ }
            }

            // Console log for debugging (optional)
            // console.log('[Analytics]', eventName, event.properties);
        } catch (err) {
            console.error('trackEvent error', err);
        }

        // Update analytics in state
        if (eventName === 'recommendation_given') state.analytics.totalRecommendations++;
        if (eventName === 'recommendation_saved') state.analytics.totalSaves++;
        saveAnalytics();
    }

    // ========== P0: IMPROVED generateShareText ==========
    function generateShareText(withUrl=false) {
        const recommendation = state.recommendation || { name: 'an awesome pick' };
        const personality = state.userPersonality || 'a Curious Explorer';
        const emoji = (personalityArchetypes[personality] || {}).emoji || 'üîç';
        
        // Shorter, more shareable format
        const text = `I'm ${personality} ${emoji}! OptiFind recommended: ${recommendation.name.substring(0, 30)}${recommendation.name.length > 30 ? '...' : ''}. Try it!`;
        
        if (withUrl) {
            const url = `${window.location.origin}${window.location.pathname}?ref=${state.userId}`;
            return `${text} ${url}`;
        }
        return text;
    }

    // ========== P0/P1: UPDATED SHARE BUTTON ==========
    shareBtn.addEventListener('click', () => {
        const url = window.location.origin + window.location.pathname + '?ref=' + state.userId + '&utm_source=share_button';
        const shareText = generateShareText(true);
        
        if (navigator.share) {
            navigator.share({
                title: 'My OptiFind Recommendation',
                text: shareText,
                url: url
            }).then(() => {
                showToast('Thanks for sharing!');
                trackEvent('shared_native');
            });
        } else {
            // Toggle social buttons with better UX
            const isVisible = socialShare.style.display === 'flex';
            socialShare.style.display = isVisible ? 'none' : 'flex';
            
            if (!isVisible) {
                showToast('Choose a platform to share');
            }
        }
    });

    // ========== P0: SHARE UNLOCK LOGIC ==========
    function maybeShowShareUnlock() {
        if (!localStorage.getItem('optifind_shared_unlock') && !localStorage.getItem('optifind_shared_unlock_skipped')) {
            const recs = state.analytics.totalRecommendations || 0;
            const saves = state.analytics.totalSaves || 0;
            if (saves >= 1 || recs >= 2) {
                setTimeout(() => {
                    shareUnlockModal.style.display = 'flex';
                }, 1000);
            }
        }
    }

    function handleShareUnlock() {
        const shareText = generateShareText(false);
        const url = window.location.origin + window.location.pathname + '?ref=' + state.userId + '&utm=share_unlock';
        if (navigator.share) {
            navigator.share({ title: 'Try OptiFind!', text: shareText, url: url }).then(() => {
                completeShareUnlock();
            }).catch(() => { completeShareUnlock(); });
        } else {
            copyToClipboard(url);
            completeShareUnlock();
        }
    }

    function completeShareUnlock() {
        localStorage.setItem('optifind_shared_unlock', 'true');
        shareUnlockModal.style.display = 'none';
        localStorage.setItem('optifind_unlocked_extra', 'true');
        showToast('Thanks! You unlocked extra recommendations.');
        trackEvent('share_unlock_completed', { method: navigator.share ? 'native' : 'copy' });
    }

    // ========== INITIALIZATION ==========
    function initApp() {
        state.currentScreen = 'welcome';
        state.userId = generateUserId();
        loadSavedRecommendations();
        loadAnalytics();
        showScreen('welcome');
        checkUrlParameters();
        updateStatsDisplay();
        showOnboardingTooltip();
        checkQuickReturn();
    }

    function generateUserId() {
        let userId = localStorage.getItem('optifind_user_id');
        if (!userId) {
            userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('optifind_user_id', userId);
        }
        return userId;
    }

    // ========== P1: ONBOARDING TOOLTIP ==========
    function showOnboardingTooltip() {
        if (!localStorage.getItem('optifind_seen_onboard')) {
            const onboard = document.createElement('div');
            onboard.style.position = 'fixed';
            onboard.style.bottom = '20px';
            onboard.style.left = '50%';
            onboard.style.transform = 'translateX(-50%)';
            onboard.style.background = 'white';
            onboard.style.padding = '12px 16px';
            onboard.style.borderRadius = '12px';
            onboard.style.boxShadow = 'var(--shadow)';
            onboard.style.zIndex = '1001';
            onboard.style.maxWidth = '90%';
            
            // FIXED: Use textContent instead of innerHTML
            const strong = document.createElement('strong');
            strong.textContent = 'Tip:';
            const text = document.createTextNode(' It only takes 3 quick questions. Share to unlock extra recommendations!');
            onboard.appendChild(strong);
            onboard.appendChild(text);
            
            document.body.appendChild(onboard);
            setTimeout(() => { 
                onboard.remove(); 
                localStorage.setItem('optifind_seen_onboard', 'true'); 
            }, 6000);
        }
    }

    // ========== ENHANCED DATA MANAGEMENT ==========
    function loadSavedRecommendations() {
        const saved = localStorage.getItem('optifind_saved');
        if (saved) {
            state.savedRecommendations = JSON.parse(saved);
            updateSavedCount();
            if (state.currentScreen === 'welcome') {
                checkAndShowRecentRecommendations();
            }
        }
    }

    function loadAnalytics() {
        const analytics = localStorage.getItem('optifind_analytics');
        if (analytics) {
            state.analytics = JSON.parse(analytics);
        }
    }

    function saveAnalytics() {
        localStorage.setItem('optifind_analytics', JSON.stringify(state.analytics));
    }

    function updateSavedCount() {
        const count = state.savedRecommendations.length;
        
        // FIXED: Use textContent for safe text insertion
        const savedIcon = document.createElement('i');
        savedIcon.className = 'fas fa-history';
        
        viewSavedBtn.textContent = '';
        viewSavedBtn.appendChild(savedIcon);
        viewSavedBtn.appendChild(document.createTextNode(` View Saved (${count})`));
        
        savedCount.textContent = count;
        
        if (viewAllSavedBtn) {
            const bookmarkIcon = document.createElement('i');
            bookmarkIcon.className = 'fas fa-bookmark';
            
            viewAllSavedBtn.textContent = '';
            viewAllSavedBtn.appendChild(bookmarkIcon);
            viewAllSavedBtn.appendChild(document.createTextNode(` View All Saved Recommendations (${count})`));
        }
    }

    function updateStatsDisplay() {
        if (!state.analytics.totalRecommendations) state.analytics.totalRecommendations = 0;
        if (!state.analytics.totalSaves) state.analytics.totalSaves = 0;

        totalRecommendations.textContent = state.analytics.totalRecommendations.toLocaleString();
        totalUsers.textContent = Math.floor(state.analytics.totalRecommendations / 3).toLocaleString();
        totalSaves.textContent = state.analytics.totalSaves.toLocaleString();
        
        statsDisplay.style.display = 'block'; 
        
        if (state.savedRecommendations.length > 0) {
            inviteFriends.style.display = 'block';
        }
        document.getElementById('footerTotalSaves').textContent = state.analytics.totalSaves.toLocaleString();
    }

    function checkQuickReturn() {
        const lastCategory = localStorage.getItem('optifind_last_category');
        const lastTime = localStorage.getItem('optifind_last_time');
        
        if (lastCategory && lastTime) {
            const hoursSince = (Date.now() - parseInt(lastTime)) / (1000 * 60 * 60);
            
            // Show only if more than 1 hour but less than 48 hours
            if (hoursSince > 1 && hoursSince < 48) {
                const quickReturnSection = document.getElementById('quickReturnSection');
                quickReturnSection.style.display = 'block';
                document.getElementById('lastCategoryName').textContent = lastCategory;
                
                // Remove existing listeners to prevent duplicates
                const btn = document.getElementById('quickReturnBtn');
                btn.replaceWith(btn.cloneNode(true));
                
                // Add new listener
                document.getElementById('quickReturnBtn').addEventListener('click', () => {
                    selectOption(lastCategory);
                });
            }
        }
    }

    // ========== P0: FIXED FALLBACK ICONS ==========
    function showRecommendation() {
        if (!state.recommendation) {
            calculateRecommendation();
        }
        
        const recommendation = state.recommendation;
        const personality = state.userPersonality;
        const personalityData = personalityArchetypes[personality] || personalityArchetypes["The Curious Explorer"];
        
        recommendationTitle.textContent = recommendation.name;
        recommendationAuthor.textContent = recommendation.author || "";
        recommendationTagline.textContent = recommendation.tagline || "";
        
        personalityBadge.textContent = `${personalityData.emoji} ${personality}`;
        personalityBadge.style.background = `linear-gradient(135deg, ${personalityData.color}, ${lightenColor(personalityData.color, 40)})`;
        
        insightText.textContent = recommendation.insight || personalityData.description;
        
        // FIXED: Clear and rebuild match tags safely
        matchTags.innerHTML = '';
        state.matchedTags.forEach(tag => {
            const tagElement = document.createElement('span');
            tagElement.className = 'match-tag';
            tagElement.textContent = tag.replace(/-/g, ' ');
            matchTags.appendChild(tagElement);
        });
        
        // FIXED: Clear recommendation logo safely
        recommendationLogo.innerHTML = '';
        
        if (recommendation.image) {
            const img = document.createElement('img');
            img.src = recommendation.image;
            img.alt = recommendation.name;
            img.loading = 'lazy';
            
            // FIXED: Create loading placeholder using DOM methods
            const loadingPlaceholder = document.createElement('div');
            loadingPlaceholder.style.color = 'var(--soft-blue)';
            loadingPlaceholder.style.fontSize = '24px';
            const spinner = document.createElement('i');
            spinner.className = 'fas fa-spinner fa-spin';
            loadingPlaceholder.appendChild(spinner);
            recommendationLogo.appendChild(loadingPlaceholder);
            
            img.onload = function() {
                recommendationLogo.innerHTML = '';
                recommendationLogo.appendChild(img);
            };

            const fallbackImages = {
                1: 'https://images.unsplash.com/photo-1544716278-ca5e3f4abd8c?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80',
                2: 'https://images.unsplash.com/photo-1512820790803-83ca734da794?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80',
                3: 'https://images.unsplash.com/photo-1541963463532-d68292c34b19?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80',
                4: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=70',
                5: 'https://images.unsplash.com/photo-1501504905252-473c47e087f8?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=70',
                6: 'https://images.unsplash.com/photo-1526379879527-8559ecfcaec5?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=70',
                7: 'https://images.unsplash.com/photo-1611224923853-80b023f02d71?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=70',
                8: 'https://images.unsplash.com/photo-1535223289827-42f1e9919769?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=70',
                9: 'https://images.unsplash.com/photo-1544717305-99670f9c28f1?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=70',
                10: 'https://images.unsplash.com/photo-1551288049-bebda4e38f71?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=70'
            };
            
            img.onerror = function() {
                if (fallbackImages[recommendation.id]) {
                    this.src = fallbackImages[recommendation.id];
                    return;
                }
                
                // FIXED: Use DOM manipulation instead of innerHTML
                this.style.display = 'none';
                const fallbackIcons = {
                    'books': 'fas fa-book',
                    'courses': 'fas fa-graduation-cap',
                    'apps': 'fas fa-mobile-alt',
                    'skills': 'fas fa-lightbulb'
                };
                const fallback = fallbackIcons[state.selectedOption] || 'fas fa-star';
                const icon = document.createElement('i');
                fallback.split(' ').forEach(cls => icon.classList.add(cls));
                icon.style.fontSize = '50px';
                icon.style.color = 'var(--soft-blue)';
                
                recommendationLogo.innerHTML = '';
                recommendationLogo.appendChild(icon);
            };
            
            recommendationLogo.appendChild(img);
        }
        
        recommendationLogo.style.backgroundColor = recommendation.color || 'var(--light-blue)';
        
        // P1: Show share buttons immediately
        socialShare.style.display = 'flex';
        
        updateSaveButtonState();
        updateStatsDisplay();
        
        // P0: Trigger share unlock check
        setTimeout(() => maybeShowShareUnlock(), 1500);
    }

    // ========== P0: REFERRAL LANDING BANNER ==========
    function checkUrlParameters() {
        const urlParams = new URLSearchParams(window.location.search);
        const ref = urlParams.get('ref');
        
        if (ref && ref !== state.userId) {
            state.referralCode = ref;
            
            // Store referral in analytics
            let referrals = JSON.parse(localStorage.getItem('optifind_referrals') || '[]');
            if (!referrals.includes(ref)) {
                referrals.push(ref);
                localStorage.setItem('optifind_referrals', JSON.stringify(referrals));
                trackEvent('referred_user', { referrer: ref });
                
                // Show referral banner
                const banner = document.createElement('div');
                banner.style.position = 'fixed';
                banner.style.top = '70px';
                banner.style.left = '50%';
                banner.style.transform = 'translateX(-50%)';
                banner.style.background = 'linear-gradient(135deg, #6C8EF5, #A8C6FF)';
                banner.style.color = '#fff';
                banner.style.padding = '10px 20px';
                banner.style.borderRadius = '999px';
                banner.style.boxShadow = 'var(--shadow)';
                banner.style.zIndex = '1001';
                
                // FIXED: Use textContent instead of innerHTML
                banner.textContent = 'Welcome! You were invited by a friend ‚Äî try OptiFind and save your first recommendation.';
                document.body.appendChild(banner);
                setTimeout(() => banner.remove(), 7000);
            }
        }
        
        // Check for saved item to load directly
        const savedId = urlParams.get('load');
        if (savedId) {
            const savedRec = state.savedRecommendations.find(r => r.id == savedId);
            if (savedRec) {
                loadSavedRecommendation(savedRec);
            }
        }
    }

    // ========== P1: UPDATED copyRecommendationLink ==========
    function copyRecommendationLink() {
        const shareText = generateShareText(false);
        const url = window.location.origin + window.location.pathname + `?load=${state.recommendation ? state.recommendation.id : ''}&ref=${state.userId}&utm_source=copy_link`;
        const textToCopy = `${shareText}\n\n${url}`;
        copyToClipboard(textToCopy);
        trackEvent('link_copied', { load: state.recommendation ? state.recommendation.id : null });
        showToast('Shareable link copied!');
    }

    // ========== P1: UPDATED shareOnPlatform ==========
    function shareOnPlatform(platform) {
        const shareText = generateShareText(true);
        const url = window.location.origin + window.location.pathname + '?ref=' + state.userId + '&utm_source=' + platform + '&utm_campaign=share';
        
        const shareUrls = {
            twitter: `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(url)}`,
            facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}&quote=${encodeURIComponent(shareText)}`,
            linkedin: `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}&summary=${encodeURIComponent(shareText)}`,
            whatsapp: `https://wa.me/?text=${encodeURIComponent(shareText + ' ' + url)}`,
            reddit: `https://www.reddit.com/submit?url=${encodeURIComponent(url)}&title=${encodeURIComponent(shareText)}`
        };

        trackEvent('shared_personality', { 
            personality: state.userPersonality,
            platform: platform 
        });
        
        if (shareUrls[platform]) {
            window.open(shareUrls[platform], '_blank', 'width=600,height=400');
            trackEvent('shared_on_platform', { platform: platform });
        }
    }

    // ========== P0: UPDATED inviteFriendsFunction ==========
    function inviteFriendsFunction() {
        const shareText = generateShareText(true);
        const url = window.location.origin + window.location.pathname + '?ref=' + state.userId;
        
        if (navigator.share) {
            navigator.share({
                title: 'Try OptiFind!',
                text: shareText,
                url: url
            }).then(() => {
                showToast('Thanks for sharing!');
                trackEvent('invite_sent', { method: 'native_share' });
            });
        } else {
            copyToClipboard(url);
            showToast('Invite link copied to clipboard!');
            trackEvent('invite_sent', { method: 'copy_link' });
        }
    }

    // ========== UTILITY FUNCTIONS ==========
    function lightenColor(color, percent) {
        const num = parseInt(color.replace("#", ""), 16);
        const amt = Math.round(2.55 * percent);
        const R = (num >> 16) + amt;
        const G = (num >> 8 & 0x00FF) + amt;
        const B = (num & 0x0000FF) + amt;
        return `#${(0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
            (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
            (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1)}`;
    }

    function copyToClipboard(text) {
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard!');
            }).catch(err => {
                fallbackCopyText(text);
            });
        } else {
            fallbackCopyText(text);
        }
    }

    function fallbackCopyText(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        
        textArea.focus();
        textArea.select();
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showToast('Copied to clipboard!');
            } else {
                showToast('Failed to copy. Please try again.');
            }
        } catch (err) {
            console.error('Failed to copy:', err);
            showToast('Failed to copy. Please try again.');
        }
        
        document.body.removeChild(textArea);
    }

    function compressData(data) {
        try {
            return btoa(JSON.stringify(data));
        } catch (e) {
            console.error('Compression failed', e);
            return JSON.stringify(data);
        }
    }

    function decompressData(data) {
        try {
            return JSON.parse(atob(data));
        } catch (e) {
            return JSON.parse(data);
        }
    }

    // ========== REST OF EXISTING FUNCTIONS (UNCHANGED) ==========
    function showScreen(screen) {
        if (screen !== state.currentScreen && screen !== 'questions') {
            showLoading('Loading...');
            setTimeout(hideLoading, 300);
        }
        welcomeScreen.style.display = 'none';
        questionScreen.style.display = 'none';
        recommendationScreen.style.display = 'none';
        feedbackModal.style.display = 'none';
        shareUnlockModal.style.display = 'none';
        saveIndicator.style.display = 'none';
        
        switch(screen) {
            case 'welcome':
                welcomeScreen.style.display = 'block';
                state.currentScreen = 'welcome';
                resetState();
                checkAndShowRecentRecommendations();
                updateStatsDisplay();
                break;
            case 'questions':
                questionScreen.style.display = 'block';
                state.currentScreen = 'questions';
                loadQuestion();
                break;
            case 'recommendation':
                recommendationScreen.style.display = 'block';
                saveIndicator.style.display = 'flex';
                state.currentScreen = 'recommendation';
                showRecommendation();
                setTimeout(() => {
                    if (!hasGivenFeedbackToday()) {
                        feedbackModal.style.display = 'flex';
                    }
                }, 2000);
                break;
        }
    }
    
    function resetState() {
        state.selectedOption = null;
        state.currentQuestionIndex = 0;
        state.userAnswers = [];
        state.userTags = [];
        state.userPersonality = null;
        state.questionWeights = [];
        state.questions = [];
        state.recommendation = null;
        state.matchedTags = [];
    }

    function loadQuestion() {
        const question = state.questions[state.currentQuestionIndex];
        
        const progress = ((state.currentQuestionIndex + 1) / state.questions.length) * 100;
        progressBar.style.width = `${progress}%`;
        
        questionNumber.textContent = `Question ${state.currentQuestionIndex + 1} of ${state.questions.length}`;
        questionText.textContent = question.question;
        
        optionsContainer.innerHTML = '';
        
        question.options.forEach((option, index) => {
            const optionElement = document.createElement('button');
            optionElement.className = 'option-btn';
            if (state.userAnswers[state.currentQuestionIndex] === index) {
                optionElement.classList.add('selected');
            }
            optionElement.textContent = option;
            optionElement.addEventListener('click', () => selectAnswer(index));
            optionsContainer.appendChild(optionElement);
        });
        
        backBtn.disabled = state.currentQuestionIndex === 0;
        nextBtn.disabled = state.userAnswers[state.currentQuestionIndex] === undefined;
        
        if (state.currentQuestionIndex === state.questions.length - 1) {
            nextBtn.innerHTML = 'Get Recommendation <i class="fas fa-check"></i>';
        } else {
            nextBtn.innerHTML = 'Next <i class="fas fa-arrow-right"></i>';
        }
    }

    function selectAnswer(answerIndex) {
        document.querySelectorAll('.option-btn').forEach(btn => {
            btn.classList.remove('selected');
        });
        
        document.querySelectorAll('.option-btn')[answerIndex].classList.add('selected');
        
        state.userAnswers[state.currentQuestionIndex] = answerIndex;
        
        const currentQuestion = state.questions[state.currentQuestionIndex];
        const selectedTag = currentQuestion.tags[answerIndex];
        
        if (!state.userTags.includes(selectedTag)) {
            state.userTags.push(selectedTag);
        }
        
        state.questionWeights[state.currentQuestionIndex] = currentQuestion.weights[answerIndex];
        
        nextBtn.disabled = false;
    }

    function goToPreviousQuestion() {
        if (state.currentQuestionIndex > 0) {
            const prevQuestion = state.questions[state.currentQuestionIndex];
            const prevAnswerIndex = state.userAnswers[state.currentQuestionIndex];
            if (prevAnswerIndex !== undefined) {
                const prevTag = prevQuestion.tags[prevAnswerIndex];
                state.userTags = state.userTags.filter(tag => tag !== prevTag);
                state.questionWeights[state.currentQuestionIndex] = null;
            }
            
            state.currentQuestionIndex--;
            loadQuestion();
        }
    }

    function goToNextQuestion() {
        if (state.userAnswers[state.currentQuestionIndex] !== undefined) {
            if (state.currentQuestionIndex === state.questions.length - 1) {
                showLoading('Analyzing your personality...');
                setTimeout(() => {
                    calculateRecommendation();
                    hideLoading();
                    showScreen('recommendation');
                }, 800); // Feels more thoughtful
            } else {
                state.currentQuestionIndex++;
                loadQuestion();
            }
        }
    }

    function retryQuestions() {
        if (state.selectedOption) {
            // Keep existing answers for editing
            state.currentQuestionIndex = 0;
            // DO NOT clear these arrays - this preserves answers for editing
            // state.userAnswers = []; // Keep
            // state.userTags = []; // Keep
            // state.questionWeights = []; // Keep
            
            showScreen('questions');
            loadQuestion(); // This will show previously selected answers
            
            showToast('Click an answer to change it');
        }
    }

    function calculateRecommendation() {
        state.userTags.push(state.selectedOption);
        
        const scoredItems = itemsDataset.map(item => {
            let score = 0;
            let matched = [];
            let tagMatches = 0;
            
            state.userTags.forEach((userTag, index) => {
                if (item.tags.includes(userTag)) {
                    const weight = state.questionWeights[index] || 1;
                    score += weight;
                    matched.push(userTag);
                    tagMatches++;
                }
            });
            
            if (item.tags.includes(state.selectedOption)) {
                score += 2;
            }
            
            const personalityMatch = calculatePersonalityMatch(item);
            score += personalityMatch * 0.5;
            
            return { item, score, matched, tagMatches };
        });
        
        scoredItems.sort((a, b) => b.score - a.score);
        const topScore = scoredItems[0].score;
        const topItems = scoredItems.filter(item => item.score === topScore);
        
        const randomIndex = Math.floor(Math.random() * topItems.length);
        state.recommendation = topItems[randomIndex].item;
        state.matchedTags = topItems[randomIndex].matched;
        
        state.userPersonality = state.recommendation.personality || "The Curious Explorer";
        
        if (topScore < 2) {
            const categoryItems = itemsDataset.filter(item => 
                item.tags.includes(state.selectedOption)
            );
            if (categoryItems.length > 0) {
                const randomFallback = Math.floor(Math.random() * categoryItems.length);
                state.recommendation = categoryItems[randomFallback];
                state.matchedTags = [state.selectedOption];
                state.userPersonality = state.recommendation.personality || "The Curious Explorer";
            }
        }
        
        state.analytics.totalRecommendations++;
        saveAnalytics();
        trackEvent('recommendation_given', {
            category: state.selectedOption,
            personality: state.userPersonality
        });
        
        // P0: Trigger share unlock check
        maybeShowShareUnlock();
    }

    function calculatePersonalityMatch(item) {
        let matchScore = 0;
        const personalityTags = {
            "practical": ["The Productivity Pragmatist", "The Practical Builder"],
            "creative": ["The Creative Dreamer"],
            "analytical": ["The Analytical Strategist", "The Data-Driven Decision Maker"],
            "big-picture": ["The Intellectual Explorer"],
            "organized": ["The Organized Optimizer"],
            "consistent": ["The Consistent Improver"],
            "social": ["The Social Connector"]
        };
        
        Object.keys(personalityTags).forEach(tag => {
            if (item.tags.includes(tag) && personalityTags[tag].includes(item.personality)) {
                matchScore++;
            }
        });
        
        return matchScore;
    }

    function updateSaveButtonState() {
        if (!state.recommendation) return;
        
        const isSaved = state.savedRecommendations.some(r => r.id === state.recommendation.id);
        
        // Update main save button
        if (isSaved) {
            saveBtn.innerHTML = '<i class="fas fa-bookmark"></i> Saved';
            saveBtn.classList.add('saved');
            saveBtn.classList.remove('tertiary');
        } else {
            saveBtn.innerHTML = '<i class="fas fa-bookmark"></i> Save Recommendation';
            saveBtn.classList.remove('saved');
            saveBtn.classList.add('tertiary');
        }
        
        // Update save indicator
        saveIndicator.innerHTML = isSaved ? '<i class="fas fa-bookmark"></i>' : '<i class="far fa-bookmark"></i>';
    }

    function handleSaveButtonClick() {
        if (!state.recommendation) return;
        
        const isSaved = state.savedRecommendations.some(r => r.id === state.recommendation.id);
        if (isSaved) {
            unsaveCurrentRecommendation();
        } else {
            saveCurrentRecommendation();
        }
    }

    function saveCurrentRecommendation() {
        if (!state.recommendation) return;
        
        const isAlreadySaved = state.savedRecommendations.some(r => r.id === state.recommendation.id);
        
        if (isAlreadySaved) {
            showToast('This recommendation is already saved!');
            return;
        }
        
        const savedRec = {
            ...state.recommendation,
            savedAt: new Date().toISOString(),
            category: state.selectedOption,
            userTags: [...state.userTags],
            personality: state.userPersonality
        };
        
        state.savedRecommendations.push(savedRec);
        state.analytics.totalSaves++;
        
        localStorage.setItem('optifind_saved', compressData(state.savedRecommendations));
        saveAnalytics();
        
        updateSaveButtonState();
        updateSavedCount();
        updateStatsDisplay();
        
        showToast(`"${state.recommendation.name}" saved!`);
        
        if (state.currentScreen === 'welcome') {
            renderRecentRecommendations();
            checkAndShowRecentRecommendations();
        }
        
        trackEvent('recommendation_saved', {
            item: state.recommendation.name,
            category: state.selectedOption
        });
        
        // P0: Trigger share unlock check
        maybeShowShareUnlock();
    }

    function unsaveCurrentRecommendation() {
        if (!state.recommendation) return;
        deleteSavedRecommendation(state.recommendation.id);
    }

    function deleteSavedRecommendation(id) {
        const recIndex = state.savedRecommendations.findIndex(r => r.id == id);
        
        if (recIndex === -1) {
            showToast('Recommendation not found');
            return;
        }
        
        const recName = state.savedRecommendations[recIndex].name;
        
        state.savedRecommendations.splice(recIndex, 1);
        localStorage.setItem('optifind_saved', JSON.stringify(state.savedRecommendations));
        
        updateSavedCount();
        
        if (savedPanel.classList.contains('show')) {
            renderSavedItems();
        }
        
        if (state.currentScreen === 'welcome') {
            renderRecentRecommendations();
            checkAndShowRecentRecommendations();
        }
        
        if (state.recommendation && state.recommendation.id == id) {
            showToast(`"${recName}" deleted`);
            updateSaveButtonState();
        } else {
            showToast(`"${recName}" deleted from saved items`);
        }
        
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
            menu.classList.remove('show');
        });
    }

    function loadSavedRecommendations() {
        try {
            const saved = localStorage.getItem('optifind_saved');
            if (saved) {
                try {
                    // Try to parse as JSON first (uncompressed)
                    state.savedRecommendations = JSON.parse(saved);
                } catch (e1) {
                    try {
                        // If that fails, try base64 decode (compressed)
                        state.savedRecommendations = JSON.parse(atob(saved));
                    } catch (e2) {
                        console.error('Failed to load saved items', e2);
                        state.savedRecommendations = [];
                    }
                }
                updateSavedCount();
                if (state.currentScreen === 'welcome') {
                    checkAndShowRecentRecommendations();
                }
            }
        } catch (e) {
            console.error('Failed to load saved items', e);
            state.savedRecommendations = [];
        }
    }

    function toggleSavedPanel() {
        savedPanel.classList.toggle('show');
        
        if (savedPanel.classList.contains('show')) {
            renderSavedItems();
        }
    }

    function renderSavedItems() {
        savedItems.innerHTML = '';
        
        if (state.savedRecommendations.length === 0) {
            // FIXED: Use DOM creation instead of innerHTML
            const emptyContainer = document.createElement('div');
            emptyContainer.style.textAlign = 'center';
            emptyContainer.style.padding = '40px';
            
            const icon = document.createElement('i');
            icon.className = 'fas fa-bookmark';
            icon.style.fontSize = '48px';
            icon.style.color = 'var(--light-blue)';
            icon.style.marginBottom = '20px';
            
            const heading = document.createElement('h3');
            heading.textContent = 'No saved recommendations yet';
            heading.style.color = 'var(--dark-grey)';
            heading.style.marginBottom = '10px';
            
            const paragraph = document.createElement('p');
            paragraph.textContent = 'Save your first recommendation to see it here!';
            paragraph.style.color = '#718096';
            
            emptyContainer.appendChild(icon);
            emptyContainer.appendChild(heading);
            emptyContainer.appendChild(paragraph);
            savedItems.appendChild(emptyContainer);
            return;
        }
        
        const sorted = [...state.savedRecommendations].sort((a, b) => 
            new Date(b.savedAt) - new Date(a.savedAt)
        );
        
        sorted.forEach((rec, index) => {
            const item = createSavedItemCard(rec, 'panel');
            savedItems.appendChild(item);
        });
        
        attachDropdownEvents('panel');
    }

    function checkAndShowRecentRecommendations() {
        if (state.savedRecommendations.length > 0) {
            recentRecommendations.style.display = 'block';
            renderRecentRecommendations();
        } else {
            recentRecommendations.style.display = 'none';
        }
    }

    function renderRecentRecommendations() {
        savedItemsGrid.innerHTML = '';
        
        if (state.savedRecommendations.length === 0) {
            // FIXED: Use DOM creation instead of innerHTML
            const emptyContainer = document.createElement('div');
            emptyContainer.style.gridColumn = '1 / -1';
            emptyContainer.style.textAlign = 'center';
            emptyContainer.style.padding = '40px';
            
            const icon = document.createElement('i');
            icon.className = 'fas fa-bookmark';
            icon.style.fontSize = '48px';
            icon.style.color = 'var(--light-blue)';
            icon.style.marginBottom = '20px';
            
            const heading = document.createElement('h3');
            heading.textContent = 'No saved recommendations yet';
            heading.style.color = 'var(--dark-grey)';
            heading.style.marginBottom = '10px';
            
            const paragraph = document.createElement('p');
            paragraph.textContent = 'Save your first recommendation to see it here!';
            paragraph.style.color = '#718096';
            
            emptyContainer.appendChild(icon);
            emptyContainer.appendChild(heading);
            emptyContainer.appendChild(paragraph);
            savedItemsGrid.appendChild(emptyContainer);
            return;
        }
        
        const recentItems = [...state.savedRecommendations]
            .sort((a, b) => new Date(b.savedAt) - new Date(a.savedAt))
            .slice(0, 3);
        
        recentItems.forEach(item => {
            const card = createSavedItemCard(item, 'home');
            savedItemsGrid.appendChild(card);
        });
        
        attachDropdownEvents('home');
    }

    function createSavedItemCard(rec, type) {
        const isHome = type === 'home';
        const container = document.createElement('div');
        const className = isHome ? 'saved-item-card' : 'saved-item';
        
        container.className = className;
        container.setAttribute('data-id', rec.id);
        
        if (isHome) {
            // Create three dots menu
            const threeDotsBtn = document.createElement('button');
            threeDotsBtn.className = 'three-dots-menu';
            threeDotsBtn.setAttribute('data-id', rec.id);
            const dotsIcon = document.createElement('i');
            dotsIcon.className = 'fas fa-ellipsis-h';
            threeDotsBtn.appendChild(dotsIcon);
            
            // Create dropdown menu
            const dropdown = document.createElement('div');
            dropdown.className = 'dropdown-menu';
            dropdown.id = `dropdown-home-${rec.id}`;
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'dropdown-item delete';
            deleteBtn.setAttribute('data-id', rec.id);
            const trashIcon = document.createElement('i');
            trashIcon.className = 'fas fa-trash';
            deleteBtn.appendChild(trashIcon);
            deleteBtn.appendChild(document.createTextNode(' Delete'));
            dropdown.appendChild(deleteBtn);
            
            // Create category
            const category = document.createElement('div');
            category.className = 'saved-item-category';
            category.textContent = rec.category;
            
            // Create name
            const name = document.createElement('div');
            name.className = 'saved-item-name';
            name.textContent = rec.name;
            
            // Create date
            const date = document.createElement('div');
            date.className = 'saved-item-date';
            date.textContent = formatDate(rec.savedAt);
            
            // Append all elements
            container.appendChild(threeDotsBtn);
            container.appendChild(dropdown);
            container.appendChild(category);
            container.appendChild(name);
            container.appendChild(date);
            
            container.addEventListener('click', (e) => {
                if (!e.target.closest('.three-dots-menu') && !e.target.closest('.dropdown-menu')) {
                    loadSavedRecommendation(rec);
                }
            });
        } else {
            // Create name
            const name = document.createElement('strong');
            name.textContent = rec.name;
            
            // Create info
            const info = document.createElement('div');
            info.style.fontSize = '12px';
            info.style.color = '#718096';
            info.style.marginTop = '5px';
            info.textContent = `${new Date(rec.savedAt).toLocaleDateString()} ‚Ä¢ ${rec.category}`;
            
            // Create three dots menu
            const threeDotsBtn = document.createElement('button');
            threeDotsBtn.className = 'three-dots-menu';
            threeDotsBtn.setAttribute('data-id', rec.id);
            const dotsIcon = document.createElement('i');
            dotsIcon.className = 'fas fa-ellipsis-h';
            threeDotsBtn.appendChild(dotsIcon);
            
            // Create dropdown menu
            const dropdown = document.createElement('div');
            dropdown.className = 'dropdown-menu';
            dropdown.id = `dropdown-${rec.id}`;
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'dropdown-item delete';
            deleteBtn.setAttribute('data-id', rec.id);
            const trashIcon = document.createElement('i');
            trashIcon.className = 'fas fa-trash';
            deleteBtn.appendChild(trashIcon);
            deleteBtn.appendChild(document.createTextNode(' Delete'));
            dropdown.appendChild(deleteBtn);
            
            // Append all elements
            container.appendChild(name);
            container.appendChild(info);
            container.appendChild(threeDotsBtn);
            container.appendChild(dropdown);
            
            container.addEventListener('click', (e) => {
                if (!e.target.closest('.three-dots-menu') && !e.target.closest('.dropdown-menu')) {
                    loadSavedRecommendation(rec);
                    savedPanel.classList.remove('show');
                }
            });
        }
        
        return container;
    }

    function attachDropdownEvents(type) {
        const prefix = type === 'home' ? 'home-' : '';
        
        // Remove any existing listeners first to prevent duplicates
        document.querySelectorAll(`.${type === 'home' ? 'saved-item-card' : 'saved-item'} .three-dots-menu`).forEach(btn => {
            btn.replaceWith(btn.cloneNode(true));
        });
        
        // Attach new listeners to three-dots menus
        document.querySelectorAll(`.${type === 'home' ? 'saved-item-card' : 'saved-item'} .three-dots-menu`).forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                e.preventDefault();
                
                const id = this.getAttribute('data-id');
                const dropdown = document.getElementById(`dropdown-${prefix}${id}`);
                
                // Close all other dropdowns
                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    if (menu !== dropdown && menu.classList.contains('show')) {
                        menu.classList.remove('show');
                    }
                });
                
                // Toggle current dropdown
                dropdown.classList.toggle('show');
            });
        });
        
        // Attach delete button listeners
        document.querySelectorAll(`.${type === 'home' ? 'saved-item-card' : 'saved-item'} .dropdown-item.delete`).forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                e.preventDefault();
                const id = this.getAttribute('data-id');
                deleteSavedRecommendation(id);
            });
        });
        
        // Global click handler to close dropdowns when clicking outside
        // Only add this once (not every time function is called)
        if (!window.dropdownClickHandlerAdded) {
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.three-dots-menu') && !e.target.closest('.dropdown-menu')) {
                    document.querySelectorAll('.dropdown-menu').forEach(menu => {
                        if (menu.classList.contains('show')) {
                            menu.classList.remove('show');
                        }
                    });
                }
            });
            window.dropdownClickHandlerAdded = true;
        }
    }

    function selectOption(option) {
        state.selectedOption = option;
        localStorage.setItem('optifind_last_category', option);
        localStorage.setItem('optifind_last_time', Date.now().toString());
        state.currentQuestionIndex = 0;
        state.userAnswers = [];
        state.userTags = [];
        state.questionWeights = [];
        state.questions = questionsData[option];
        showScreen('questions');
        trackEvent('category_selected', { category: option });
    }

    function hasGivenFeedbackToday() {
        const lastFeedback = localStorage.getItem('optifind_last_feedback');
        if (!lastFeedback) return false;
        
        const lastDate = new Date(lastFeedback);
        const today = new Date();
        return lastDate.toDateString() === today.toDateString();
    }

    function submitFeedback(type) {
        feedbackModal.style.display = 'none';
        
        if (type === 'accurate') {
            state.analytics.feedbackAccurate++;
            showToast('Thanks! Your feedback helps us improve.');
        } else {
            state.analytics.feedbackNeutral++;
            showToast('Thanks for the feedback!');
        }
        
        localStorage.setItem('optifind_last_feedback', new Date().toISOString());
        saveAnalytics();
        
        trackEvent('feedback_given', { type: type });
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffInHours = Math.floor((now - date) / (1000 * 60 * 60));
        
        if (diffInHours < 24) {
            return `${diffInHours} hour${diffInHours !== 1 ? 's' : ''} ago`;
        } else {
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric' 
            });
        }
    }

    function showToast(message) {
        toastMessage.textContent = message;
        toast.classList.add('show');
        
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    function showLoading(message = 'Loading...') {
        const overlay = document.getElementById('loadingOverlay');
        overlay.querySelector('.loading-text').textContent = message;
        overlay.style.display = 'flex';
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    // ========== MISSING FUNCTION: loadSavedRecommendation ==========
    function loadSavedRecommendation(savedRec) {
        state.recommendation = savedRec;
        state.userPersonality = savedRec.personality || "The Curious Explorer";
        state.selectedOption = savedRec.category;
        state.matchedTags = savedRec.userTags || [];
        showScreen('recommendation');
    }

    // ========== DEBUGGING EXPORTS ==========
    window.optifind = {
        exportData: () => {
            const data = {
                userId: state.userId,
                savedRecommendations: state.savedRecommendations,
                analytics: state.analytics,
                events: JSON.parse(localStorage.getItem('optifind_events') || '[]')
            };
            console.log(JSON.stringify(data, null, 2));
        },
        showState: () => console.log(state),
        resetData: () => {
            localStorage.clear();
            location.reload();
        }
    };

    // Service Worker Registration
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log('SW registered'))
                .catch(err => console.log('SW error', err));
        });
    }
</script>

    <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Finding your perfect match...</div>
</div>  
</body>
</html>